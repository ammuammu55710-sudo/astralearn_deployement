{% extends 'base.html' %}

{% block extra_css %}
<style>
    .progress-radial {
        width: 120px;
        height: 120px;
        border-radius: 50%;

        background: radial-gradient(closest-side, var(--glass-bg) 79%, transparent 80% 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
        box-shadow: 0 0 15px rgba(80, 200, 255, 0.2);
    }

    .progress-radial::before {
        content: "{{ progress_percent }}%";
        font-size: 1.5rem;
        font-weight: bold;
        color: var(--secondary-color);
    }

    .lock-banner {
        background: rgba(255, 68, 68, 0.1);
        border: 1px solid #ff4444;
        padding: 1rem;
        border-radius: 10px;
        margin-top: 1rem;
        font-size: 0.9rem;
        color: #ff8888;
        display: flex;
        align-items: center;
        gap: 0.8rem;
    }

    .status-completed {
        border-left: 5px solid #4caf50;
    }

    .status-unlocked {
        border-left: 5px solid var(--secondary-color);
    }

    .status-locked {
        border-left: 5px solid #444;
    }
</style>
{% endblock %}

{% block content %}
<div class="glass-panel" style="margin-bottom: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: start;">
        <div style="flex: 1;">
            <h1 style="color: var(--primary-color);">{{ group.name }}</h1>

        </div>
        <div style="text-align: right; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
            <div class="status-badge"
                style="background: var(--accent-color); color: white; padding: 0.3rem 0.8rem; border-radius: 20px;">AI
                Admin Sync: OK</div>
            <div style="display: flex; gap: 0.5rem;">
                {% if not is_member %}
                <a href="{% url 'join_group' group.pk %}" class="btn-primary">Join</a>
                {% else %}
                <a href="{% url 'leave_group' group.pk %}" class="btn-glow"
                    style="background: rgba(255, 68, 68, 0.1); border-color: #ff4444; color: #ff8888;">Leave Group</a>
                {% endif %}
                {% if group.creator == request.user %}
                <a href="{% url 'delete_group' group.pk %}" class="btn-primary"
                    style="background: #ff4444; border: none;"
                    onclick="return confirm('Delete this group entirelly?')">Delete</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2.2fr 1fr; gap: 2rem;">
    <!-- Learning Path Section -->
    <div class="glass-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">üìÖ Week {{ group.current_week }} Schedule</h2>
            <div style="display: flex; gap: 1rem; align-items: center;">
                <span class="badge"
                    style="background: rgba(255,255,255,0.1); padding: 0.2rem 0.6rem; border-radius: 10px; font-size: 0.8rem;">
                    {{ completed_count }} / {{ total_days }} Completed
                </span>
                {% if can_take_test %}
                <a href="{% url 'advance_week' group.pk %}" class="btn-glow"
                    onclick="return confirm('Starting the next week will reset your daily progress for the new schedule. Continue?')"
                    style="font-size: 0.8rem; padding: 0.4rem 1rem; background: rgba(100, 255, 100, 0.1); border-color: #64ff64; color: #88ff88;">
                    Start Next Week ‚û°Ô∏è
                </a>
                {% else %}
                <button class="btn-primary"
                    style="font-size: 0.8rem; padding: 0.4rem 1rem; opacity: 0.4; cursor: not-allowed;"
                    title="Complete all tasks to unlock next week" disabled>
                    Next Week üîí
                </button>
                {% endif %}
            </div>
        </div>

        <div style="display: flex; flex-direction: column; gap: 1.2rem;">
            {% for day in schedule %}
            <div class="card status-{{ day.status }}" style="position: relative;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="margin: 0;">
                        {% if day.status == 'completed' %} ‚úÖ {% elif day.status == 'locked' %} üîí {% endif %}
                        Day {{ day.day }}: {{ day.topic }}
                    </h3>
                    <span style="font-size: 0.8rem; opacity: 0.6;">{{ day.time }}</span>
                </div>

                {% if day.status != 'locked' %}
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.05);">
                    <div style="font-size: 0.9rem; color: #ccc; line-height: 1.6;">{{ day.daily_notes }}</div>

                    {% if day.status == 'unlocked' %}
                    <div style="text-align: right; margin-top: 1.5rem;">
                        <a href="{% url 'complete_day' group.pk day.day %}" class="btn-primary"
                            style="font-size: 0.8rem; padding: 0.4rem 1rem;">Finish Today</a>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <p style="margin-top: 0.8rem; font-style: italic; font-size: 0.85rem; color: #666;">Locked item.
                    Complete Step {{ day.day|add:"-1" }} first.</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Side Panel: Stats & Assessment -->
    <div style="display: flex; flex-direction: column; gap: 2rem;">
        <!-- Performance Scoreboard -->
        <div class="glass-panel" style="text-align: center;">
            <h3 style="margin-bottom: 1.5rem;">Group Scoreboard</h3>
            <div class="progress-radial"
                style="background: radial-gradient(closest-side, var(--glass-bg) 79%, transparent 80% 100%), conic-gradient(var(--secondary-color) {{ progress_percent }}%, rgba(255, 255, 255, 0.1) 0);">
            </div>
            <p style="font-weight: bold; color: var(--secondary-color);">WEEKLY COMPLETION</p>
            <p style="font-size: 0.8rem; opacity: 0.6; margin-top: 0.5rem;">You have completed {{ completed_count }}/{{
                total_days }} tasks</p>
        </div>

        <!-- Weekly Assessment Lock -->
        <div class="glass-panel">
            <h3>Assessment Center</h3>
            <div style="margin-top: 1.5rem;">
                {% if can_take_test %}
                <p style="color: #44ff44; font-size: 0.9rem; margin-bottom: 1rem;">‚ú® Weekly Assessment Unlocked!</p>
                <a href="{% url 'generate_test' group.id %}" class="btn-glow"
                    style="display: block; text-align: center;">Take Weekly Exam</a>
                {% else %}
                <button class="btn-primary" style="width: 100%; opacity: 0.4; cursor: not-allowed;" disabled>Locked
                    Assessment</button>
                <div class="lock-banner">
                    <span>üõ°Ô∏è</span>
                    <div>Complete all 7 tasks on the scoreboard to unlock this test.</div>
                </div>
                {% endif %}
            </div>

            <div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 0.8rem;">
                <a href="{% url 'collaborate_room' group.id %}" class="btn-primary"
                    style="text-align: center; font-size: 0.9rem;">Join Video Chat</a>
            </div>
        </div>

        <!-- Members Info -->
        <div class="glass-panel">
            <h4>Squad Members</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem;">
                {% for member in group.members.all %}
                <span
                    style="background: rgba(255,255,255,0.05); padding: 0.3rem 0.6rem; border-radius: 5px; font-size: 0.8rem;">üë§
                    {{ member.username }}</span>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}